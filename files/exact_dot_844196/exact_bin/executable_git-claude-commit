#!/usr/bin/env zsh

zparseopts -D -E - -amend=opt_amend

skill="commit-headless"
if (( $#opt_amend )); then
  skill="commit-amend-headless"
fi

head_before=$(git rev-parse HEAD 2>/dev/null)

claude --print --verbose --model haiku --output-format stream-json -p "/$skill $*" \
  | jq -r 'select(.type == "assistant") | .message.content[]? | select(.type? == "text") | .text'

head_after=$(git rev-parse HEAD 2>/dev/null)
if [[ "$head_before" != "$head_after" ]]; then
  exit 0
fi

claude --continue
